<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propiedades</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .filtros-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .filtros-container input {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .filtros-container button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        #btn-filtrar {
            background: #3b82f6;
            color: white;
        }

        #btn-limpiar {
            background: #e5e7eb;
            color: #374151;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #1f2937;
        }

        .propiedades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .propiedad-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .propiedad-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .propiedad-imagen {
            position: relative;
            height: 200px;
            overflow: hidden;
        }

        .propiedad-imagen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .propiedad-status {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .propiedad-status.disponible {
            background: #10b981;
            color: white;
        }

        .propiedad-status.reservado {
            background: #f59e0b;
            color: white;
        }

        .location-icon {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            background: #38bdf8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            z-index: 10;
        }

        .location-icon:hover {
            transform: scale(1.1);
        }

        .location-icon.rotating {
            animation: spin 0.6s ease-in-out;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .location-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .map-container {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }

        .map-container.active {
            display: block;
        }

        .propiedad-imagen img.hidden {
            display: none;
        }

        .propiedad-content {
            padding: 20px;
        }

        .propiedad-precio {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .propiedad-direccion {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .propiedad-features {
            display: flex;
            justify-content: left;
            gap: 16px;
        }

        .feature {
            font-size: 14px;
            color: #4b5563;
            font-weight: 500;
        }

        .whatsapp-btn {
            display: inline-block;
            margin-top: 36px;
            padding: 10px 20px;
            background: #25d366;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            transition: background 0.2s;
        }

        .whatsapp-btn:hover {
            background: #128c7e;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-size: 18px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ef4444;
        }

        /* BOTN FILTROS MVIL */
        .btn-open-filtros {
            display: none;
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
        }

        /* WRAPPER NORMAL (DESKTOP) */
        .filtros-wrapper {
            position: static;
        }

        /* MODO MVIL */
        @media (max-width: 768px) {

            .btn-open-filtros {
                display: block;
            }

            .filtros-wrapper {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.55);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 999;
            }

            .filtros-wrapper.active {
                display: flex;
            }

            .filtros-container {
                flex-direction: column;
                width: 90%;
                max-width: 420px;
            }
        }
    </style>
</head>

<body>
    <!-- Bot贸n visible SOLO en m贸vil -->
    <button class="btn-open-filtros" id="btn-open-filtros">
        Filtrar 
    </button>

    <!-- Wrapper overlay -->
    <div class="filtros-wrapper" id="filtros-wrapper">

        <!-- TU BLOQUE ORIGINAL, intacto -->
        <div class="filtros-container">
            <input type="number" id="filtro-precio-min" placeholder="Precio min UF">
            <input type="number" id="filtro-precio-max" placeholder="Precio max UF">
            <input type="number" id="filtro-habitaciones" placeholder="Dormitorios min">
            <input type="number" id="filtro-banos" placeholder="Ba帽os min">
            <input type="number" id="filtro-metros" placeholder="M虏 min">
            <button id="btn-filtrar">Filtrar</button>
            <button id="btn-limpiar">Limpiar</button>
        </div>

    </div>

    <div class="container">
        <h1>Propiedades</h1>
        <div id="propiedades-container" class="propiedades-grid">
            <p class="loading">Cargando propiedades</p>
        </div>
    </div>

    <script>
        // Funci贸n para crear elemento con atributos y contenido seguro
        function createElement(tag, attrs = {}, text = '') {
            const el = document.createElement(tag);
            Object.entries(attrs).forEach(([key, val]) => el.setAttribute(key, val));
            if (text) el.textContent = text;
            return el;
        }

        // Crear una card de propiedad
        function createCard(prop) {
            const article = createElement('article', { class: 'propiedad-card' });

            // Imagen
            const imgContainer = createElement('div', { class: 'propiedad-imagen' });
            const img = createElement('img', {
                src: prop.image,
                alt: prop.address,
                loading: 'lazy'
            });
            const status = createElement('span', {
                class: `propiedad-status ${prop.status.toLowerCase()}`
            }, prop.status);

            // Icono de ubicaci贸n celeste
            const locationIcon = createElement('div', { class: 'location-icon' });
            locationIcon.innerHTML = `
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
            `;

            // Contenedor del mapa (iframe)
            const mapContainer = createElement('iframe', {
                class: 'map-container',
                allowfullscreen: '',
                loading: 'lazy'
            });

            // Evento click para el icono de ubicaci贸n
            locationIcon.addEventListener('click', () => {
                // Agregar clase de rotaci贸n
                locationIcon.classList.add('rotating');

                // Quitar clase de rotaci贸n despu茅s de la animaci贸n
                setTimeout(() => {
                    locationIcon.classList.remove('rotating');
                }, 600);

                // Toggle entre imagen y mapa
                const isMapVisible = mapContainer.classList.contains('active');

                if (!isMapVisible) {
                    // Mostrar mapa
                    const encodedAddress = encodeURIComponent(prop.address);
                    mapContainer.src = `https://maps.google.com/maps?q=${encodedAddress}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
                    img.classList.add('hidden');
                    mapContainer.classList.add('active');
                } else {
                    // Volver a mostrar imagen
                    img.classList.remove('hidden');
                    mapContainer.classList.remove('active');
                    mapContainer.src = '';
                }
            });

            imgContainer.append(img, status, locationIcon, mapContainer);

            // Contenido
            const content = createElement('div', { class: 'propiedad-content' });
            const price = createElement('h3', { class: 'propiedad-precio' }, `${prop.price} UF`);
            const address = createElement('p', { class: 'propiedad-direccion' }, prop.address);

            // Features
            const features = createElement('div', { class: 'propiedad-features' });
            const rooms = createElement('span', { class: 'feature' }, `${prop.rooms}D`);
            const baths = createElement('span', { class: 'feature' }, `${prop.baths}B`);
            const area = createElement('span', { class: 'feature' }, `${prop.area}m虏`);

            // Bot贸n WhatsApp
            const whatsappBtn = createElement('a', {
                class: 'whatsapp-btn',
                href: `https://wa.me/+56979785883?text=Hola , me interesa la propiedad en ${encodeURIComponent(prop.address)} - ${prop.price} UF`,
                target: '_blank',
                rel: 'noopener noreferrer'
            }, 'Contactanos');

            features.append(rooms, baths, area);
            content.append(price, address, features, whatsappBtn);
            article.append(imgContainer, content);

            return article;
        }

        async function loadProperties() {
            const container = document.getElementById('propiedades-container');

            try {
                const response = await fetch('properties_with_commune.json');
                if (!response.ok) throw new Error('No se pudo cargar el JSON');

                propiedadesOriginales = await response.json();

                container.textContent = '';
                propiedadesOriginales.forEach(prop => {
                    container.appendChild(createCard(prop));
                });

            } catch (error) {
                container.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        function filtrarPropiedades() {
            const precioMin = parseFloat(document.getElementById('filtro-precio-min').value) || 0;
            const precioMax = parseFloat(document.getElementById('filtro-precio-max').value) || Infinity;
            const habitaciones = parseInt(document.getElementById('filtro-habitaciones').value) || 0;
            const banos = parseInt(document.getElementById('filtro-banos').value) || 0;
            const metros = parseInt(document.getElementById('filtro-metros').value) || 0;

            const filtradas = propiedadesOriginales.filter(prop => {
                return prop.price >= precioMin &&
                    prop.price <= precioMax &&
                    prop.rooms >= habitaciones &&
                    prop.baths >= banos &&
                    prop.area >= metros;
            });

            const container = document.getElementById('propiedades-container');
            container.textContent = '';

            if (filtradas.length === 0) {
                container.innerHTML = '<p class="loading">No se encontraron propiedades con esos filtros</p>';
            } else {
                filtradas.forEach(prop => {
                    container.appendChild(createCard(prop));
                });
            }
        }

        function limpiarFiltros() {
            document.getElementById('filtro-precio-min').value = '';
            document.getElementById('filtro-precio-max').value = '';
            document.getElementById('filtro-habitaciones').value = '';
            document.getElementById('filtro-banos').value = '';
            document.getElementById('filtro-metros').value = '';

            const container = document.getElementById('propiedades-container');
            container.textContent = '';
            propiedadesOriginales.forEach(prop => {
                container.appendChild(createCard(prop));
            });
        }

        const filtrosWrapper = document.getElementById('filtros-wrapper');
        const btnOpenFiltros = document.getElementById('btn-open-filtros');

        btnOpenFiltros.addEventListener('click', () => {
            filtrosWrapper.classList.add('active');
        });

        /* Cerrar al filtrar */
        document.getElementById('btn-filtrar').addEventListener('click', () => {
            filtrarPropiedades();
            filtrosWrapper.classList.remove('active');
        });

        /* Cerrar al limpiar */
        document.getElementById('btn-limpiar').addEventListener('click', () => {
            limpiarFiltros();
            filtrosWrapper.classList.remove('active');
        });

        /* Cerrar tocando el overlay */
        filtrosWrapper.addEventListener('click', (e) => {
            if (e.target === filtrosWrapper) {
                filtrosWrapper.classList.remove('active');
            }
        });


        // Event listeners
        document.getElementById('btn-filtrar').addEventListener('click', filtrarPropiedades);
        document.getElementById('btn-limpiar').addEventListener('click', limpiarFiltros);

        document.addEventListener('DOMContentLoaded', loadProperties);
    </script>

    <script src="comuna-filter.js"></script>
</body>

</html>
